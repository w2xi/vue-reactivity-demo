<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.bootcdn.net/ajax/libs/underscore.js/1.13.3/underscore-min.js"></script>
  <script>
    _.templateSettings.interpolate = /\{\{(.+?)\}\}/g
  </script>
</head>
<body>
  <div id="app">
    <div>{{ name }}</div>
    <div>{{ age }}</div>
  </div>
  <script>
    const data = {
      name: 'w2xi',
      age: 26,
    };

    const sharedPropertyDefinition = {
      enumerable: true,
      configurable: true,
      get: noop,
      set: noop,
    }

    let tplRender;

    const vm = new MyVue({
      el: '#app',
      data: data,
    })
    
    function MyVue(options) {
      options = options || {}
      let el = options.el;
      const data = options.data || {};

      this.data = data;

      if (typeof el === 'string') {
        el = document.querySelector(el);
        template = el.innerHTML;
      } else if (el.nodeType === 1) {
        template = el.innerHTML;
      } else {
        el = document.createElement('div');
        document.body.appendChild(el);
        template = el.innerHTML
      }
      
      tplRender = () => render(el, _.template(template));
      tplRender();

      Object.keys(data).forEach(key => {
        defineReactive(data, key);
        proxy(this, 'data', key);
      });
    }

    function defineReactive(obj, key) {
      let val = obj[key];

      Object.defineProperty(obj, key, {
        enumerable: true,
        configurable: true,
        get() {
          return val;
        },
        set(newVal) {
          console.log('new value:', newVal);
          val = newVal;
          tplRender();
        },
      })
    }

    function noop() {}
    function proxy(target, sourceKey, key) {
      sharedPropertyDefinition.get = function proxyGetter() {
        return target[sourceKey][key];
      }
      sharedPropertyDefinition.set = function proxySetter(val) {
        target[sourceKey][key] = val;
      }
      Object.defineProperty(target, key, sharedPropertyDefinition);
    }

    function render(element, fn) {
      element.innerHTML = fn(data);
    }
  </script>
</body>
</html>